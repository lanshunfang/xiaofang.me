<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, minimum-scale=1.0"/>
    <title>微信网站微信中继...</title>
    <style>
        #wechat_iframe {
            position: absolute;
            left: -2px;
            top: -2px;
            right: -2px;
            bottom: -2px;
        }

        #loading {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: #fff;
            opacity: .9;
            transition: all 2s;
        }

        #loading p.default {
            margin-bottom: 0;
        }

        #loading .loading-longer {
            color: #ff6708
        }

        #loading .loading-connected {
            color: #0061b9
        }

        #wechat_img, #wechat_summary {
            height: 1px;
            width: 1px;
            overflow: hidden;
            opacity: .1;
            position: fixed;
            bottom: 0;
            left: 0
        }

        .hide {
            display: none;
        }
        .website-host {
            font-weight: bold;
            font-style: italic;
        }
    </style>
</head>
<body>
<div id="wechat_img"><img id="featured" width="800" height="600"
                          src="//www.xiaofang.me/wp-content/uploads/2014/11/unnamed.png"/></div>
<div id="wechat_summary">守望的微信网站跳转中……</div>
<iframe id="wechat_iframe" height="100%" width="100%" src="">
</iframe>

<h1 id="loading">
    <p class="default">正在载入网站 <span class="website-host"></span> ... </p>
    <p class="loading-connected hide">网站已经连接成功，正在加载完整数据....</p>
    <p class="loading-longer hide">不好意思，好像加载时间略长一些，请再耐心等等。</p>
    <p class="loading-failure hide">
        如果不想等，请点击微信右上角，选择"在浏览器(Safari/QQ)打开"；或者直接在你的手机浏览器里输入 <span class="website-host"></span>：
    </p>
</h1>
<script>
    (function () {
        var doc = document;
        var win = window;
        var lastUrlPosted;
        var loc = location;

        var loading = doc.querySelector('#loading');
        var loadingDefault = doc.querySelector('#loading .default');
        var connected = doc.querySelector('#loading .loading-connected');
        var loadingLonger = doc.querySelector('#loading .loading-longer');
        var loadingFailure = doc.querySelector('#loading .loading-failure');
        var iframe = doc.querySelector('#wechat_iframe');

        var intervalNotifyId = setInterval(ensureUrlUpdated, 500);

        var linkPlaceholder = '--WC--';
        var path = loc.pathname.replace(/\//, '');
        var prefix = path.split('.').length > 2 ? 'https://' : 'https://www.';
        var urlToJumpTo = prefix + path;
        iframe.src = urlToJumpTo;

        [].forEach.call(doc.querySelectorAll('.website-host'), function (hostDiv) {
            hostDiv.innerText = urlToJumpTo;
        });

        win.addEventListener('message', function (e) {
            var message = e.data;

            clearTimeout(intervalNotifyId);
            setTimeout(ensureUrlUpdated, 100);

            if (message.msgTitle === 'connected') {
                clearTimeout(window.globalLoadingTimeout);
                loadingDefault.style.display = 'none';
                loadingLonger.style.display = 'none';
                loadingFailure.style.display = 'none';

            }

            if (message.msgTitle) {

                return
            }

            clearTimeout(window.globalLoadingTimeout);
            loadingLonger.style.display = 'none';
            loadingFailure.style.display = 'none';

            loading.style.transform = 'translate(0px, -100px)';
            loading.style.opacity = 0.5;
            setTimeout(function () {
                loading.style.display = 'none';
            }, 1000);
            var title = message.title;
            var description = message.description;

            var url = lastUrlPosted = message.url;
            if (!url) {
                console.error('[ERROR] url does not exist');
                return
            }

            if (message.isReplaceHref) {
                loc.href = url.replace(/^\/\//g, 'http://');
            } else {
                doc.title = title;
                loc.hash = encodeURI(url.replace('#', linkPlaceholder));
                if (message.imgSrc) {
                    doc.getElementById('featured').src = message.imgSrc;
                }
                if (description) {
                    doc.getElementById('wechat_summary').innerText = description;
                }
            }

        });

        doc.addEventListener("DOMContentLoaded", function () {
            updateIFrameByUrl();
            updateLoading()

        });

        function updateIFrameByUrl() {

            var hash = loc.hash;
            if (hash.length > 2) {
                var url = decodeURI(hash.slice(1)).replace(linkPlaceholder, '#');
                if (iframe.src != url && lastUrlPosted !== url) {
                    iframe.src = url;
                }
            }

        }

        function updateLoading() {
            window.globalLoadingTimeout = setTimeout(function () {
                loadingDefault.style.display = 'none';
                loadingLonger.style.display = 'block';

                setTimeout(function () {
                    loadingLonger.style.display = 'none';
                    loadingFailure.style.display = 'block';
                    setTimeout(function () {
                        loadingFailure.style.display = 'none'
                    }, 5000)
                }, 8000)
            }, 7000)
        }

        function ensureUrlUpdated() {
            var iframeWin = iframe.contentWindow;

            if (!iframeWin) return;

            iframeWin.postMessage({
                type: 'wechat_unblocker'
            }, '*');

        }
    })()


</script>

</body>
</html>
