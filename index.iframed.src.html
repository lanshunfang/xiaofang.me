<script>
    // Insert this script right after <title> in "<html><head>...</title>HERE</head>"
    // must use https://htmlcompressor.com/compressor/ to compress this doc to index.html

    (function () {
        var intervalNotifyId = setInterval(notifyParentLoading, 500);
        var isMessageGot = false;

        var doc = document;
        var win = window;
        var loc = location;
        var host = loc.host;

        var clickedLinkText;
        var clickedLinkTextExtra;

        var linkPlaceholder = '--WC--';
        var url = loc.href;
        loc.href = url.replace(linkPlaceholder, '#')

        win.addEventListener('message', function (msg) {
            clearInterval(intervalNotifyId);
            if (!isMessageGot) {
                setTimeout(notifyParentLoading, 100)
            }
            isMessageGot = true;

        }, false);


        doc.addEventListener("DOMContentLoaded", function (event) {

            var $ = jQuery;

            var parent = win.parent;
            if (!parent) return;

            win.addEventListener('message', function (msg) {
                if (msg.type === 'wechat_unblocker') {
                    delayUpdateParent();
                }

            }, false);

            delayUpdateParent();

            win.addEventListener("hashchange", function (event) {
                delayUpdateParent();
            });

            $('body').on('click', 'a', function (e) {
                var $a = $(this);
                var href = $a.attr('href');
                if (/\/\//.test(href) && !href.match(host)) {
                    updateParent(true, href);
                } else {
                    delayUpdateParent();
                }
            }).on('mouseenter', 'a', function (e) {
                var $a = $(this);

                clickedLinkText = $a.text();
                clickedLinkTextExtra =  ' ( '
                    + $a.attr('href').split('/').reverse().reduce(function (previousValue, currentValue) {
                        if (previousValue && previousValue.length > 3) {
                            return previousValue
                        }
                        // you should set your title in path
                        if (currentValue.length > 5) {
                            return decodeURIComponent(currentValue);
                        }
                    }, '')
                    + ' )'
            });

            function delayUpdateParent() {
                setTimeout(function () {
                    updateParent();
                }, 1000)
            }

            function updateParent(isReplaceHref, href) {

                var parent = win.parent;
                if (!parent) {
                    return;
                }

                var $featuredImg = $('.wp-post-image:first');

                if (!$featuredImg.length) {
                    $featuredImg = $('.size-large:first')
                }

                if (!$featuredImg.length) {
                    $featuredImg = $('.size-full:first')
                }

                if (!$featuredImg.length) {
                    var area = 0;
                    $('img').each(function () {
                        var w = parseInt($(this).attr('width')) || 1;
                        var h = parseInt($(this).attr('height')) || 1;
                        var _area = w * h;
                        if (_area > area) {
                            area = _area;
                            $featuredImg = $(this)
                        }
                    });
                }

                parent.postMessage({
                    msgTitle: 'updateParent',
                    title: doc.title,
                    description: $('.entry-content').clone().find('#toc_container').remove().end().find('p').text(),
                    url: href || loc.href,
                    path: loc.path,
                    search: loc.search,
                    hash: loc.hash,
                    isReplaceHref: isReplaceHref,
                    imgSrc: $featuredImg.attr('src')
                }, '*');
            }

        });

        win.addEventListener('beforeunload', function () {
            notifyParentBeforeUnload();
        }, false);

        win.addEventListener('unload', function () {
            notifyParentUnload();
        }, false);


        function notifyParentBeforeUnload() {
            var parent = win.parent;
            parent.postMessage({
                msgTitle: 'beforeunload',
                targetTitle: clickedLinkText,
                targetTitleExtra: clickedLinkTextExtra,
            }, '*');
        }

        function notifyParentUnload() {
            var parent = win.parent;
            parent.postMessage({
                msgTitle: 'unload',
            }, '*');
        }

        function notifyParentLoading() {

            var parent = win.parent;
            if (!parent) {
                clearInterval(intervalNotifyId);
                return;
            };

            parent.postMessage({
                msgTitle: 'connected'
            }, '*');
        }


    })();
</script>